<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Valente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        .loading-spinner {
             border: 4px solid rgba(0,0,0,0.1);
             border-top: 4px solid #3498db;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        #map { height: 100%; width: 100%; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-pending { background-color: #fef9c3; color: #ca8a04; }
        .status-inprogress { background-color: #dbeafe; color: #2563eb; }
        .status-completed { background-color: #dcfce7; color: #16a34a; }
        /* Adicionando transições suaves aos modais */
        .modal-transition { transition: opacity 300ms ease-in-out, transform 300ms ease-in-out; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="toast-container" class="fixed top-5 right-5 z-[1000] space-y-2"></div>

    <!-- Indicador de Carregamento Global -->
    <div id="global-loader" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-[9999]">
        <div class="loading-spinner w-16 h-16 rounded-full animate-spin"></div>
    </div>

    <!-- Tela de Login -->
    <div id="login-page" class="flex items-center justify-center h-screen bg-gray-200 hidden">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-lg shadow-md">
            <div class="text-center">
                 <div class="mx-auto w-16 h-16 flex items-end gap-1">
                     <div class="w-1/3 h-1/2 bg-sky-400 rounded-sm"></div>
                     <div class="w-1/3 h-full bg-sky-500 rounded-sm"></div>
                     <div class="w-1/3 h-1/3 bg-sky-600 rounded-sm"></div>
                 </div>
                <h2 class="mt-6 text-3xl font-bold text-gray-900">
                    GESTOR VALENTE
                </h2>
                <p class="mt-2 text-sm text-gray-600">
                    Por favor, inicie a sessão para continuar
                </p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Endereço de email</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Endereço de email">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Palavra-passe</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Palavra-passe">
                    </div>
                </div>
                <div>
                    <button type="submit" id="login-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Entrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Conteúdo Principal da Aplicação (inicialmente escondido) -->
    <div id="app-container" class="hidden h-screen">
        <aside class="w-64 bg-slate-800 text-white flex flex-col">
            <div class="p-6 flex items-center gap-3 border-b border-slate-700">
                <div class="w-10 h-10 flex items-end gap-1">
                    <div class="w-1/3 h-1/2 bg-sky-400 rounded-sm"></div>
                    <div class="w-1/3 h-full bg-sky-500 rounded-sm"></div>
                    <div class="w-1/3 h-1/3 bg-sky-600 rounded-sm"></div>
                </div>
                <span class="text-xl font-bold">GESTOR VALENTE</span>
            </div>
            <nav id="sidebar-nav" class="flex-1 p-4">
                <ul>
                    <li><a href="#dashboard" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg bg-slate-900 font-semibold"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>Dashboard</a></li>
                    <li><a href="#cidadaos" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Cidadãos</a></li>
                    <li><a href="#demandas" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Demandas</a></li>
                    <li id="users-nav-link" class="hidden"><a href="#utilizadores" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Utilizadores</a></li>
                </ul>
            </nav>
            <div class="p-4 mt-auto border-t border-slate-700">
                <button id="logout-btn" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg bg-red-600 hover:bg-red-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Sair
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col h-screen">
            <main id="dashboard-page" class="page flex-1 flex-col h-screen overflow-y-auto">
                 <header class="bg-white p-6 border-b"><h1 class="text-2xl font-bold text-gray-800">Dashboard Estratégico</h1><p class="text-gray-600">Visão geral e insights da sua base de contatos.</p></header>
                <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-500">Total de Cidadãos</h3><p id="dashboard-total-cidadaos" class="text-4xl font-bold text-blue-600">0</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-500">Total de Demandas</h3><p id="dashboard-total-demandas" class="text-4xl font-bold text-purple-600">0</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm md:col-span-2"><h3 class="text-lg font-semibold text-gray-500 mb-4">Cidadãos por Tipo</h3><canvas id="cidadaos-por-tipo-chart"></canvas></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm md:col-span-2"><h3 class="text-lg font-semibold text-gray-500 mb-4">Demandas por Status</h3><canvas id="demandas-por-status-chart"></canvas></div>
                    </div>
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-500 mb-4">Aniversariantes do Mês</h3><div id="aniversariantes-list" class="space-y-3 max-h-48 overflow-y-auto"></div></div>
                        <div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-500 mb-4">Demandas Recentes</h3><div id="demandas-recentes-list" class="space-y-3 max-h-96 overflow-y-auto"></div></div>
                    </div>
                </div>
            </main>
            
            <main id="cidadaos-page" class="page hidden flex-1 flex-col h-screen overflow-y-auto">
                 <header class="bg-white p-6 border-b space-y-4">
                    <div class="flex justify-between items-center gap-4 flex-wrap">
                        <div><h1 class="text-2xl font-bold text-gray-800">Gestão de Cidadãos</h1><p class="text-gray-600">Adicione, filtre e gerencie seus contatos na nuvem.</p></div>
                        <div class="flex items-center gap-4">
                             <button id="generate-report-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>Gerar Relatório</button>
                             <button id="view-map-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>Visualizar no Mapa</button>
                             <button id="add-cidadao-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">Adicionar Novo Cidadão</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="relative md:col-span-2"><input type="text" id="search-input" placeholder="Buscar por nome, e-mail ou CPF..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div></div>
                        <select id="filter-type" class="w-full border-gray-300 rounded-lg bg-white"><option value="">Filtrar por Tipo</option><option>Apoiador</option><option>Liderança</option><option>Eleitor</option><option>Candidato</option><option>Outro</option></select>
                        <select id="filter-bairro" class="w-full border-gray-300 rounded-lg bg-white"><option value="">Filtrar por Bairro</option></select>
                        <select id="filter-leader" class="w-full border-gray-300 rounded-lg bg-white"><option value="">Filtrar por Liderança</option></select>
                        <button id="clear-filters-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg">Limpar Filtros</button>
                    </div>
                </header>
                <div id="cidadaos-grid" class="flex-1 p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </main>

            <main id="demandas-page" class="page hidden flex-1 flex-col h-screen overflow-y-auto">
                <header class="bg-white p-6 border-b space-y-4">
                     <div class="flex justify-between items-center gap-4 flex-wrap">
                        <div><h1 class="text-2xl font-bold text-gray-800">Central de Demandas</h1><p class="text-gray-600">Visualize e gerencie todas as solicitações.</p></div>
                        <button id="add-demanda-geral-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">Adicionar Nova Demanda</button>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <select id="demanda-filter-status" class="w-full border-gray-300 rounded-lg bg-white"><option value="">Filtrar por Status</option><option value="pending">Pendente</option><option value="inprogress">Em Andamento</option><option value="completed">Concluída</option></select>
                        <select id="demanda-filter-leader" class="w-full border-gray-300 rounded-lg bg-white"><option value="">Filtrar por Liderança</option></select>
                        <button id="demanda-clear-filters-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg">Limpar Filtros</button>
                    </div>
                </header>
                <div id="all-demandas-list" class="flex-1 p-6 space-y-3"></div>
            </main>

            <main id="utilizadores-page" class="page hidden flex-1 flex-col h-screen overflow-y-auto">
                <header class="bg-white p-6 border-b flex justify-between items-center flex-wrap">
                    <div><h1 class="text-2xl font-bold text-gray-800">Gestão de Utilizadores</h1><p class="text-gray-600">Adicione e gerencie os membros da sua equipa.</p></div>
                    <button id="add-user-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md mt-4 sm:mt-0">Adicionar Novo Utilizador</button>
                </header>
                <div class="p-6">
                    <div class="bg-white rounded-lg shadow-sm overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 border-b-2 border-gray-200">
                                <tr>
                                    <th class="p-4">Email</th>
                                    <th class="p-4">Nível de Acesso</th>
                                    <th class="p-4">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Linhas da tabela de utilizadores serão inseridas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modals -->
        <div id="cidadao-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-40 overflow-y-auto p-4">
            <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-4xl modal-transition scale-95 opacity-0 my-auto" id="modal-content">
                <div class="flex justify-between items-center mb-6"><h2 id="cidadao-modal-title" class="text-2xl font-bold">Adicionar Novo Cidadão</h2><button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button></div>
                <form id="cidadao-form">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Dados Pessoais</h3>
                            <div><label for="cidadao-name" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label><input type="text" id="cidadao-name" class="w-full border border-gray-300 p-2 rounded-lg" required></div>
                            <div><label for="cidadao-email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label><input type="email" id="cidadao-email" class="w-full border border-gray-300 p-2 rounded-lg" required></div>
                            <div><label for="cidadao-dob" class="block text-sm font-medium text-gray-700 mb-1">Data de Nascimento</label><input type="date" id="cidadao-dob" class="w-full border border-gray-300 p-2 rounded-lg"></div>
                            <div><label for="cidadao-profissao" class="block text-sm font-medium text-gray-700 mb-1">Profissão</label><input type="text" id="cidadao-profissao" class="w-full border border-gray-300 p-2 rounded-lg"></div>
                            <div><label for="cidadao-local-trabalho" class="block text-sm font-medium text-gray-700 mb-1">Local de Trabalho</label><input type="text" id="cidadao-local-trabalho" class="w-full border border-gray-300 p-2 rounded-lg"></div>
                            <div><label for="cidadao-leader" class="block text-sm font-medium text-gray-700 mb-1">Liderança que Indicou</label><select id="cidadao-leader" class="w-full border border-gray-300 p-2 rounded-lg bg-white"></select></div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Documentos e Contato</h3>
                            <div><label for="cidadao-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label><select id="cidadao-type" class="w-full border border-gray-300 p-2 rounded-lg bg-white"><option>Apoiador</option><option>Liderança</option><option>Eleitor</option><option>Candidato</option><option>Outro</option></select></div>
                            <div><label for="cidadao-cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF</label><input type="text" id="cidadao-cpf" class="w-full border border-gray-300 p-2 rounded-lg" placeholder="000.000.000-00"></div>
                            <div><label for="cidadao-rg" class="block text-sm font-medium text-gray-700 mb-1">RG</label><input type="text" id="cidadao-rg" class="w-full border border-gray-300 p-2 rounded-lg"></div>
                            <div><label for="cidadao-voterid" class="block text-sm font-medium text-gray-700 mb-1">Título de Eleitor</label><input type="text" id="cidadao-voterid" class="w-full border border-gray-300 p-2 rounded-lg" placeholder="0000 0000 0000"></div>
                            <div>
                                <label for="cidadao-phone" class="block text-sm font-medium text-gray-700 mb-1">Contato (Telefone)</label>
                                <div class="flex items-center">
                                    <input type="tel" id="cidadao-phone" class="w-full border border-gray-300 p-2 rounded-l-lg" placeholder="(00) 00000-0000">
                                    <div class="flex items-center pl-3 pr-2 border-t border-b border-r rounded-r-lg h-full"><input id="cidadao-whatsapp" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded"><label for="cidadao-whatsapp" class="ml-2 text-sm text-gray-600">WhatsApp</label></div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Endereço e Família</h3>
                            <div><label for="cidadao-cep" class="block text-sm font-medium text-gray-700 mb-1">CEP</label><input type="text" id="cidadao-cep" class="w-full border border-gray-300 p-2 rounded-lg" placeholder="00000-000"></div>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="col-span-3"><label for="cidadao-logradouro" class="block text-sm font-medium text-gray-700 mb-1">Logradouro</label><input type="text" id="cidadao-logradouro" class="w-full border border-gray-300 p-2 rounded-lg"></div>
                                <div><label for="cidadao-numero" class="block text-sm font-medium text-gray-700 mb-1">Nº</label><input type="text" id="cidadao-numero" class="w-full border border-gray-300 p-2 rounded-lg"></div>
                                <div class="col-span-2"><label for="cidadao-complemento" class="block text-sm font-medium text-gray-700 mb-1">Complemento</label><input type="text" id="cidadao-complemento" class="w-full border border-gray-300 p-2 rounded-lg"></div>
                                <div class="col-span-3"><label for="cidadao-bairro" class="block text-sm font-medium text-gray-700 mb-1">Bairro</label><input type="text" id="cidadao-bairro" class="w-full border border-gray-300 p-2 rounded-lg"></div>
                                <div class="col-span-2"><label for="cidadao-cidade" class="block text-sm font-medium text-gray-700 mb-1">Cidade</label><input type="text" id="cidadao-cidade" class="w-full border border-gray-300 p-2 rounded-lg"></div>
                                <div><label for="cidadao-estado" class="block text-sm font-medium text-gray-700 mb-1">UF</label><input type="text" id="cidadao-estado" class="w-full border border-gray-300 p-2 rounded-lg"></div>
                            </div>
                            <div class="flex gap-4 pt-2">
                                <div><label for="cidadao-sons" class="block text-sm font-medium text-gray-700 mb-1">Filhos</label><input type="number" id="cidadao-sons" class="w-full border border-gray-300 p-2 rounded-lg" min="0" value="0"></div>
                                <div><label for="cidadao-daughters" class="block text-sm font-medium text-gray-700 mb-1">Filhas</label><input type="number" id="cidadao-daughters" class="w-full border border-gray-300 p-2 rounded-lg" min="0" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div id="children-details-container" class="mt-6 space-y-4"></div>

                    <div class="mt-6 border-t pt-4">
                        <label class="block text-lg font-semibold text-gray-800 mb-2">Foto do Perfil</label>
                        <div class="mt-1 flex items-center">
                             <div class="w-full">
                                <label for="cidadao-photo-upload" class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50">
                                    <span>Carregar uma foto</span>
                                    <input id="cidadao-photo-upload" name="cidadao-photo-upload" type="file" class="sr-only" accept="image/*">
                                </label>
                                <span id="file-name-display" class="ml-3 text-sm text-gray-600">Nenhuma foto selecionada</span>
                            </div>
                             <img id="photo-preview" src="" alt="Pré-visualização da Foto" class="h-16 w-16 rounded-full object-cover hidden ml-4">
                        </div>
                         <progress id="upload-progress" value="0" max="100" class="w-full mt-2 hidden"></progress>
                    </div>
                    <div class="flex justify-end gap-4 pt-6 mt-6 border-t">
                        <button type="button" id="cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" id="save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="cidadao-details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 overflow-y-auto p-4">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl modal-transition scale-95 opacity-0 my-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div id="details-photo" class="w-24 h-24 rounded-full"></div>
                            <div>
                                <h2 id="details-name" class="text-2xl font-bold text-gray-800"></h2>
                                <p id="details-type" class="text-gray-600"></p>
                            </div>
                        </div>
                        <button id="close-details-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-4">
                        <div>
                            <h3 class="font-semibold text-gray-500 text-sm mb-2">INFORMAÇÕES DE CONTATO</h3>
                            <p><strong>Email:</strong> <span id="details-email"></span></p>
                            <p><strong>Telefone:</strong> <span id="details-phone"></span></p>
                            <p><strong>Endereço:</strong> <span id="details-address"></span></p>
                        </div>
                         <div>
                            <h3 class="font-semibold text-gray-500 text-sm mb-2">DOCUMENTOS</h3>
                            <p><strong>CPF:</strong> <span id="details-cpf"></span></p>
                            <p><strong>RG:</strong> <span id="details-rg"></span></p>
                            <p><strong>Título de Eleitor:</strong> <span id="details-voterid"></span></p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-500 text-sm mb-2">INFORMAÇÕES ADICIONAIS</h3>
                            <p><strong>Data de Nasc.:</strong> <span id="details-dob"></span></p>
                            <p><strong>Profissão:</strong> <span id="details-profissao"></span></p>
                            <p><strong>Local de Trabalho:</strong> <span id="details-local-trabalho"></span></p>
                            <p><strong>Indicado por:</strong> <span id="details-leader"></span></p>
                            <div id="details-children" class="mt-2"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 flex justify-end gap-4 rounded-b-lg">
                    <button id="details-share-location-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                        Partilhar Localização
                    </button>
                    <button id="details-view-map-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        Ver no Mapa
                    </button>
                </div>
            </div>
        </div>

        <div id="demanda-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="demanda-modal-title" class="text-2xl font-bold">Nova Demanda</h2>
                    <button id="close-demanda-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <form id="demanda-form">
                     <div class="mb-4">
                        <label for="demanda-cidadao-select" class="block text-sm font-medium text-gray-700 mb-1">Para o Cidadão</label>
                        <select id="demanda-cidadao-select" class="w-full border border-gray-300 p-3 rounded-lg bg-white" required></select>
                    </div>
                    <div class="mb-4">
                        <label for="demanda-title" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input type="text" id="demanda-title" class="w-full border border-gray-300 p-3 rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="demanda-description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                        <textarea id="demanda-description" rows="3" class="w-full border border-gray-300 p-3 rounded-lg"></textarea>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" id="cancel-demanda-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" id="save-demanda-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg">Salvar Demanda</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="demanda-details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold" id="details-demanda-title"></h2>
                        <p class="text-sm text-gray-500" id="details-demanda-cidadao"></p>
                    </div>
                     <div class="flex items-center gap-4">
                        <button id="delete-demanda-btn" title="Excluir Demanda" class="p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                        </button>
                        <button id="close-demanda-details-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto pr-4 -mr-4">
                    <p class="text-gray-700 mb-4" id="details-demanda-description"></p>
                    <div class="mb-4">
                        <label for="details-demanda-status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="details-demanda-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="pending">Pendente</option>
                            <option value="inprogress">Em Andamento</option>
                            <option value="completed">Concluída</option>
                        </select>
                    </div>
                    <h3 class="text-lg font-semibold mt-6 mb-2 border-t pt-4">Histórico de Acompanhamento</h3>
                    <div id="demanda-notes-list" class="space-y-3 mb-4"></div>
                </div>
                <form id="add-note-form" class="mt-4 border-t pt-4">
                    <label for="new-note-text" class="block text-sm font-medium text-gray-700 mb-1">Adicionar Acompanhamento</label>
                    <textarea id="new-note-text" rows="2" class="w-full border border-gray-300 p-2 rounded-lg" required></textarea>
                    <div class="flex justify-end mt-2">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Adicionar Nota</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
             <div class="bg-white rounded-lg shadow-2xl w-full h-full flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Localização dos Cidadãos</h2>
                    <button id="close-map-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <div id="map" class="flex-1 rounded-b-lg"></div>
            </div>
        </div>
        
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-sm">
                <h2 id="confirmation-title" class="text-xl font-bold mb-4">Confirmar Exclusão</h2>
                <p id="confirmation-message" class="text-gray-600 mb-6">Você tem certeza?</p>
                <div class="flex justify-end gap-4">
                    <button id="cancel-delete-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button id="confirm-delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Excluir</button>
                </div>
            </div>
        </div>

        <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="user-modal-title" class="text-2xl font-bold">Novo Utilizador</h2>
                    <button id="close-user-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <form id="user-form">
                     <div class="mb-4">
                        <label for="user-email" class="block text-sm font-medium text-gray-700 mb-1">Email do Utilizador</label>
                        <input type="email" id="user-email" class="w-full border border-gray-300 p-3 rounded-lg" required placeholder="email@exemplo.com">
                    </div>
                     <div class="mb-4">
                        <label for="user-uid" class="block text-sm font-medium text-gray-700 mb-1">User ID (UID)</label>
                        <input type="text" id="user-uid" class="w-full border border-gray-300 p-3 rounded-lg" required placeholder="Cole o UID do Firebase Auth aqui">
                        <p class="text-xs text-gray-500 mt-1">Crie o utilizador no Firebase Authentication primeiro e cole o UID aqui.</p>
                    </div>
                    <div class="mb-6">
                        <label for="user-role" class="block text-sm font-medium text-gray-700 mb-1">Nível de Acesso</label>
                        <select id="user-role" class="w-full border border-gray-300 p-3 rounded-lg bg-white" required>
                            <option value="Assessor">Assessor (Acesso Limitado)</option>
                            <option value="Administrador">Administrador (Acesso Total)</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" id="cancel-user-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" id="save-user-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Salvar Utilizador</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Firebase SDK e Lógica da Aplicação -->
    <script type="module">
        // 1. Importar as bibliotecas do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- Variáveis de Ambiente e Configuração Segura ---
        // Estas variáveis são injetadas pelo ambiente de execução para segurança.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { /* Suas chaves de desenvolvimento podem ir aqui, mas NUNCA em produção */ };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gestor-valente-crm';

        // 3. Inicializar o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // --- Referências às coleções ---
        const cidadaosCollection = collection(db, "cidadaos");
        const demandasCollection = collection(db, "demandas");
        const usersCollection = collection(db, "users");


        document.addEventListener('DOMContentLoaded', () => {
            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const globalLoader = document.getElementById('global-loader');
            
            let currentUserRole = null;
            let unsubscribeCidadaos, unsubscribeDemandas, unsubscribeUsers;

            // --- Lógica de Autenticação ---
            onAuthStateChanged(auth, async user => {
                // Se já houver um ouvinte, cancele-o para evitar duplicações
                if (unsubscribeCidadaos) unsubscribeCidadaos();
                if (unsubscribeDemandas) unsubscribeDemandas();
                if (unsubscribeUsers) unsubscribeUsers();

                if (user) {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    currentUserRole = userDocSnap.exists() ? userDocSnap.data().role : 'Assessor'; // Padrão seguro
                    
                    loginPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('flex');
                    initializeMainApp();
                } else {
                    currentUserRole = null;
                    loginPage.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    appContainer.classList.remove('flex');
                    globalLoader.classList.add('hidden'); // Esconde o loader se não estiver logado
                }
            });

            // Autenticação automática via token injetado ou login anônimo
            const authenticate = async () => {
                try {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else if (!auth.currentUser) {
                        // Se não há token, mostre a página de login manual
                         globalLoader.classList.add('hidden');
                         loginPage.classList.remove('hidden');
                    }
                } catch(error) {
                    console.error("Authentication error:", error);
                    globalLoader.classList.add('hidden');
                    loginPage.classList.remove('hidden');
                }
            };
            authenticate();


            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email-address').value;
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('login-btn');
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<div class="spinner"></div>';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    showToast('Email ou palavra-passe inválidos.', 'error');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = 'Entrar';
                }
            });
            
            let appInitialized = false;
            function initializeMainApp() {
                if (appInitialized) return;
                appInitialized = true;

                // --- Seletores de Elementos (Aplicação Principal) ---
                const logoutBtn = document.getElementById('logout-btn');
                const sidebarNav = document.getElementById('sidebar-nav');
                const pages = document.querySelectorAll('.page');
                const dashboardTotalCidadaos = document.getElementById('dashboard-total-cidadaos');
                const dashboardTotalDemandas = document.getElementById('dashboard-total-demandas');
                const aniversariantesList = document.getElementById('aniversariantes-list');
                const demandasRecentesList = document.getElementById('demandas-recentes-list');
                const addCidadaoBtn = document.getElementById('add-cidadao-btn');
                const cidadaoModal = document.getElementById('cidadao-modal');
                const cidadaoModalTitle = document.getElementById('cidadao-modal-title');
                const closeModalBtn = document.getElementById('close-modal-btn');
                const cancelBtn = document.getElementById('cancel-btn');
                const cidadaoForm = document.getElementById('cidadao-form');
                const saveBtn = document.getElementById('save-btn');
                const cidadaosGrid = document.getElementById('cidadaos-grid');
                const searchInput = document.getElementById('search-input');
                const sonsInput = document.getElementById('cidadao-sons');
                const daughtersInput = document.getElementById('cidadao-daughters');
                const childrenContainer = document.getElementById('children-details-container');
                const leaderSelect = document.getElementById('cidadao-leader');
                const filterType = document.getElementById('filter-type');
                const filterBairro = document.getElementById('filter-bairro');
                const filterLeader = document.getElementById('filter-leader');
                const clearFiltersBtn = document.getElementById('clear-filters-btn');
                const generateReportBtn = document.getElementById('generate-report-btn');
                const cidadaoDetailsModal = document.getElementById('cidadao-details-modal');
                const closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
                const detailsViewMapBtn = document.getElementById('details-view-map-btn');
                const detailsShareLocationBtn = document.getElementById('details-share-location-btn');
                const addDemandaGeralBtn = document.getElementById('add-demanda-geral-btn');
                const allDemandasList = document.getElementById('all-demandas-list');
                const demandaFilterStatus = document.getElementById('demanda-filter-status');
                const demandaFilterLeader = document.getElementById('demanda-filter-leader');
                const demandaClearFiltersBtn = document.getElementById('demanda-clear-filters-btn');
                const demandaModal = document.getElementById('demanda-modal');
                const closeDemandaModalBtn = document.getElementById('close-demanda-modal-btn');
                const cancelDemandaBtn = document.getElementById('cancel-demanda-btn');
                const demandaForm = document.getElementById('demanda-form');
                const demandaFormCidadaoSelect = document.getElementById('demanda-cidadao-select');
                const demandaDetailsModal = document.getElementById('demanda-details-modal');
                const closeDemandaDetailsBtn = document.getElementById('close-demanda-details-btn');
                const detailsDemandaTitle = document.getElementById('details-demanda-title');
                const detailsDemandaCidadao = document.getElementById('details-demanda-cidadao');
                const detailsDemandaDescription = document.getElementById('details-demanda-description');
                const detailsDemandaStatus = document.getElementById('details-demanda-status');
                const demandaNotesList = document.getElementById('demanda-notes-list');
                const addNoteForm = document.getElementById('add-note-form');
                const newNoteText = document.getElementById('new-note-text');
                const deleteDemandaBtn = document.getElementById('delete-demanda-btn');
                const mapModal = document.getElementById('map-modal');
                const viewMapBtn = document.getElementById('view-map-btn');
                const closeMapBtn = document.getElementById('close-map-btn');
                const confirmationModal = document.getElementById('confirmation-modal');
                const confirmationTitle = document.getElementById('confirmation-title');
                const confirmationMessage = document.getElementById('confirmation-message');
                const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
                const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
                const usersNavLink = document.getElementById('users-nav-link');
                const addUserBtn = document.getElementById('add-user-btn');
                const userModal = document.getElementById('user-modal');
                const closeUserModalBtn = document.getElementById('close-user-modal-btn');
                const cancelUserBtn = document.getElementById('cancel-user-btn');
                const userForm = document.getElementById('user-form');
                const usersTableBody = document.getElementById('users-table-body');
                const uploadProgress = document.getElementById('upload-progress');
                const photoPreview = document.getElementById('photo-preview');
                
                let allCidadaos = [], allDemandas = [], allLeaders = [], allUsers = [], editingCidadaoId = null, viewingCidadaoId = null;
                let itemToDelete = { id: null, type: null }, viewingDemandaId = null, notesUnsubscribe = null;
                let map = null, markers = [], cidadaosChart = null, demandasChart = null;

                logoutBtn.addEventListener('click', async () => {
                    try { await signOut(auth); appInitialized = false; } catch (error) { showToast('Erro ao terminar a sessão.', 'error'); }
                });
                
                function switchPage(pageId) {
                    pages.forEach(p => p.classList.add('hidden'));
                    document.getElementById(pageId).classList.remove('hidden');
                    sidebarNav.querySelectorAll('a').forEach(link => {
                        link.classList.remove('bg-slate-900', 'font-semibold');
                        link.classList.add('hover:bg-slate-700');
                        if (link.getAttribute('href') === `#${pageId.replace('-page', '')}`) {
                            link.classList.add('bg-slate-900', 'font-semibold');
                            link.classList.remove('hover:bg-slate-700');
                        }
                    });
                }
                sidebarNav.addEventListener('click', (e) => {
                    const link = e.target.closest('a');
                    if (link) { e.preventDefault(); switchPage(link.getAttribute('href').substring(1) + '-page'); }
                });

                function applyPermissions(role) {
                    const adminOnlyElements = document.querySelectorAll('#users-nav-link, #generate-report-btn, #add-user-btn');
                    if (role === 'Administrador') {
                        adminOnlyElements.forEach(el => el.classList.remove('hidden'));
                        document.querySelectorAll('.delete-cidadao-btn, #delete-demanda-btn, .delete-user-btn').forEach(btn => btn.style.display = 'flex');
                    } else { // Assessor
                        adminOnlyElements.forEach(el => el.classList.add('hidden'));
                        document.querySelectorAll('.delete-cidadao-btn, #delete-demanda-btn, .delete-user-btn').forEach(btn => btn.style.display = 'none');
                    }
                }
                
                function updateDashboard() {
                    dashboardTotalCidadaos.textContent = allCidadaos.length;
                    dashboardTotalDemandas.textContent = allDemandas.length;
                    renderAniversariantesDoMes();
                    renderDemandasRecentes();
                    renderCidadaosPorTipoChart();
                    renderDemandasPorStatusChart();
                }
                function renderAniversariantesDoMes() {
                    const today = new Date();
                    const currentMonth = today.getMonth();
                    const aniversariantes = allCidadaos.filter(c => {
                        if (!c.dob) return false;
                        const birthDate = new Date(c.dob);
                        return birthDate.getUTCMonth() === currentMonth;
                    }).sort((a, b) => new Date(a.dob).getUTCDate() - new Date(b.dob).getUTCDate());
                    aniversariantesList.innerHTML = '';
                    if (aniversariantes.length === 0) {
                        aniversariantesList.innerHTML = '<p class="text-gray-500 text-sm">Nenhum aniversariante este mês.</p>';
                    } else {
                        aniversariantes.forEach(c => {
                            const birthDate = new Date(c.dob);
                            const day = String(birthDate.getUTCDate()).padStart(2, '0');
                            const el = document.createElement('div');
                            el.className = 'aniversariante-item flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 cursor-pointer';
                            el.dataset.id = c.id;
                            el.innerHTML = `<span class="font-medium text-gray-700 pointer-events-none">${c.name}</span><span class="font-bold text-blue-600 pointer-events-none">${day}</span>`;
                            aniversariantesList.appendChild(el);
                        });
                    }
                }
                aniversariantesList.addEventListener('click', (e) => {
                    const item = e.target.closest('.aniversariante-item');
                    if (item) openCidadaoDetailsModal(item.dataset.id);
                });
                function renderDemandasRecentes() {
                    demandasRecentesList.innerHTML = '';
                    const recentDemandas = allDemandas.slice(0, 5);
                    if (recentDemandas.length === 0) {
                        demandasRecentesList.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma demanda recente.</p>';
                    } else {
                        recentDemandas.forEach(demanda => {
                            const cidadao = allCidadaos.find(c => c.id === demanda.cidadaoId);
                            const el = document.createElement('div');
                            el.className = 'p-2 rounded-lg hover:bg-gray-100';
                            el.innerHTML = `<p class="font-semibold text-gray-800 truncate">${demanda.title}</p><p class="text-sm text-gray-500">Para: ${cidadao ? cidadao.name : 'Desconhecido'}</p>`;
                            demandasRecentesList.appendChild(el);
                        });
                    }
                }
                function renderCidadaosPorTipoChart() {
                    const ctx = document.getElementById('cidadaos-por-tipo-chart').getContext('2d');
                    const typeCounts = allCidadaos.reduce((acc, c) => { acc[c.type] = (acc[c.type] || 0) + 1; return acc; }, {});
                    if (cidadaosChart) cidadaosChart.destroy();
                    cidadaosChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(typeCounts), datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#ec4899', '#f97316'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
                }
                function renderDemandasPorStatusChart() {
                    const ctx = document.getElementById('demandas-por-status-chart').getContext('2d');
                    const statusCounts = allDemandas.reduce((acc, d) => { const status = d.status || 'pending'; acc[status] = (acc[status] || 0) + 1; return acc; }, {});
                    if (demandasChart) demandasChart.destroy();
                    demandasChart = new Chart(ctx, { type: 'bar', data: { labels: ['Status das Demandas'], datasets: [ { label: 'Pendentes', data: [statusCounts['pending'] || 0], backgroundColor: '#f59e0b' }, { label: 'Em Andamento', data: [statusCounts['inprogress'] || 0], backgroundColor: '#3b82f6' }, { label: 'Concluídas', data: [statusCounts['completed'] || 0], backgroundColor: '#22c55e' } ] }, options: { responsive: true, indexAxis: 'y', scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } } });
                }

                function renderCidadaos() {
                    let filteredCidadaos = [...allCidadaos];
                    const searchTerm = searchInput.value.toLowerCase();
                    if (searchTerm) { filteredCidadaos = filteredCidadaos.filter(c => c.name.toLowerCase().includes(searchTerm) || c.email.toLowerCase().includes(searchTerm) || (c.cpf && c.cpf.includes(searchTerm))); }
                    const type = filterType.value;
                    if (type) { filteredCidadaos = filteredCidadaos.filter(c => c.type === type); }
                    const bairro = filterBairro.value;
                    if (bairro) { filteredCidadaos = filteredCidadaos.filter(c => c.address && c.address.bairro === bairro); }
                    const leaderId = filterLeader.value;
                    if (leaderId) { filteredCidadaos = filteredCidadaos.filter(c => c.leaderId === leaderId); }
                    
                    if (cidadaosGrid.innerHTML === '' && filteredCidadaos.length === 0) {
                         cidadaosGrid.innerHTML = `<div class="col-span-full text-center mt-8 p-6 bg-white rounded-lg shadow-sm">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhum cidadão encontrado</h3>
                            <p class="mt-1 text-sm text-gray-500">Tente limpar os filtros ou adicione um novo cidadão.</p>
                        </div>`;
                         return;
                    }

                    cidadaosGrid.innerHTML = filteredCidadaos.map(cidadao => {
                        const photoElement = cidadao.photo ? `<img src="${cidadao.photo}" class="w-24 h-24 object-cover rounded-full" alt="Foto de ${cidadao.name}">` : `<div class="w-24 h-24 ${cidadao.color || 'bg-gray-500'} rounded-full flex items-center justify-center text-white text-3xl font-bold">${cidadao.initials || '??'}</div>`;
                        const deleteBtnHtml = currentUserRole === 'Administrador' ? `<button data-id="${cidadao.id}" aria-label="Excluir Cidadão" class="delete-cidadao-btn bg-red-500 text-white w-7 h-7 rounded-full flex items-center justify-center hover:bg-red-600 text-xl font-bold">&times;</button>` : '';
                        return `
                            <div data-id="${cidadao.id}" class="cidadao-card bg-white rounded-lg p-5 shadow-sm text-center flex flex-col items-center transition-transform transform hover:-translate-y-1 cursor-pointer">
                                <div class="relative w-24 h-24 mb-4 pointer-events-none">
                                    ${photoElement}
                                    <div class="absolute -top-1 -right-1 flex flex-col gap-1 pointer-events-auto">
                                        <button data-id="${cidadao.id}" aria-label="Editar Cidadão" class="edit-cidadao-btn bg-gray-600 text-white w-7 h-7 rounded-full flex items-center justify-center hover:bg-gray-700 p-1.5"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" /></svg></button>
                                        ${deleteBtnHtml}
                                    </div>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 pointer-events-none">${cidadao.name}</h3>
                                <p class="text-gray-500 pointer-events-none">${cidadao.type}</p>
                                <p class="text-xs text-gray-400 mt-2 truncate w-full pointer-events-none" title="${cidadao.phone || ''}">${cidadao.phone || 'Sem contato'}</p>
                            </div>
                        `;
                    }).join('');
                }
                [searchInput, filterType, filterBairro, filterLeader].forEach(el => el.addEventListener('input', renderCidadaos));
                clearFiltersBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    filterType.value = '';
                    filterBairro.value = '';
                    filterLeader.value = '';
                    renderCidadaos();
                });
                function populateFilterDropdowns() {
                    const bairros = [...new Set(allCidadaos.map(c => c.address?.bairro).filter(Boolean))].sort();
                    const currentBairro = filterBairro.value;
                    filterBairro.innerHTML = '<option value="">Filtrar por Bairro</option>';
                    bairros.forEach(bairro => {
                        const option = document.createElement('option');
                        option.value = bairro;
                        option.textContent = bairro;
                        filterBairro.appendChild(option);
                    });
                    filterBairro.value = currentBairro;
                    const currentLeader = filterLeader.value;
                    filterLeader.innerHTML = '<option value="">Filtrar por Liderança</option>';
                    allLeaders.forEach(leader => {
                        const option = document.createElement('option');
                        option.value = leader.id;
                        option.textContent = leader.name;
                        filterLeader.appendChild(option);
                    });
                    filterLeader.value = currentLeader;
                }
                
                function openCidadaoModal(cidadaoId = null) {
                    editingCidadaoId = cidadaoId;
                    populateLeadersDropdown(true); 
                    if (editingCidadaoId) {
                        const cidadao = allCidadaos.find(c => c.id === editingCidadaoId);
                        cidadaoModalTitle.textContent = "Editar Cidadão";
                        document.getElementById('cidadao-name').value = cidadao.name;
                        document.getElementById('cidadao-email').value = cidadao.email;
                        document.getElementById('cidadao-dob').value = cidadao.dob || '';
                        document.getElementById('cidadao-type').value = cidadao.type;
                        document.getElementById('cidadao-leader').value = cidadao.leaderId || '';
                        document.getElementById('cidadao-cpf').value = cidadao.cpf || '';
                        document.getElementById('cidadao-rg').value = cidadao.rg || '';
                        document.getElementById('cidadao-voterid').value = cidadao.voterId || '';
                        document.getElementById('cidadao-phone').value = cidadao.phone || '';
                        document.getElementById('cidadao-whatsapp').checked = cidadao.hasWhatsApp || false;
                        document.getElementById('cidadao-profissao').value = cidadao.profissao || '';
                        document.getElementById('cidadao-local-trabalho').value = cidadao.localTrabalho || '';
                        
                        if(cidadao.address) {
                            document.getElementById('cidadao-cep').value = cidadao.address.cep || '';
                            document.getElementById('cidadao-logradouro').value = cidadao.address.logradouro || '';
                            document.getElementById('cidadao-numero').value = cidadao.address.numero || '';
                            document.getElementById('cidadao-complemento').value = cidadao.address.complemento || '';
                            document.getElementById('cidadao-bairro').value = cidadao.address.bairro || '';
                            document.getElementById('cidadao-cidade').value = cidadao.address.cidade || '';
                            document.getElementById('cidadao-estado').value = cidadao.address.estado || '';
                        }

                        sonsInput.value = cidadao.sons || 0;
                        daughtersInput.value = cidadao.daughters || 0;
                        renderChildrenFields();
                         if (cidadao.children && cidadao.children.length > 0) {
                            const fieldsets = childrenContainer.querySelectorAll('fieldset');
                            fieldsets.forEach((fieldset, index) => {
                                if(cidadao.children[index]) {
                                    fieldset.querySelector('.child-detail-name').value = cidadao.children[index].name || '';
                                    fieldset.querySelector('.child-detail-cpf').value = cidadao.children[index].cpf || '';
                                    fieldset.querySelector('.child-detail-dob').value = cidadao.children[index].dob || '';
                                }
                            });
                        }
                        if (cidadao.photo) {
                            photoPreview.src = cidadao.photo;
                            photoPreview.classList.remove('hidden');
                        }
                    } else {
                        cidadaoModalTitle.textContent = "Adicionar Novo Cidadão";
                    }
                    cidadaoModal.classList.remove('hidden');
                    setTimeout(() => document.getElementById('modal-content').classList.remove('scale-95', 'opacity-0'), 10);
                }

                function closeCidadaoModal() {
                    document.getElementById('modal-content').classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        cidadaoModal.classList.add('hidden');
                        cidadaoForm.reset();
                        childrenContainer.innerHTML = '';
                        document.getElementById('file-name-display').textContent = 'Nenhuma foto selecionada';
                        photoPreview.classList.add('hidden');
                        photoPreview.src = '';
                        uploadProgress.classList.add('hidden');
                        editingCidadaoId = null;
                    }, 300);
                }
                addCidadaoBtn.addEventListener('click', () => openCidadaoModal());
                closeModalBtn.addEventListener('click', closeCidadaoModal);
                cancelBtn.addEventListener('click', closeCidadaoModal);
                
                cidadaosGrid.addEventListener('click', (e) => {
                    const card = e.target.closest('.cidadao-card');
                    const editBtn = e.target.closest('.edit-cidadao-btn');
                    const deleteBtn = e.target.closest('.delete-cidadao-btn');
                    
                    if (editBtn) {
                        openCidadaoModal(editBtn.dataset.id);
                    } else if (deleteBtn) {
                        openConfirmationModal(deleteBtn.dataset.id, 'cidadao');
                    } else if (card) {
                        openCidadaoDetailsModal(card.dataset.id);
                    }
                });
                
                closeDetailsModalBtn.addEventListener('click', closeCidadaoDetailsModal);

                document.getElementById('cidadao-cep').addEventListener('blur', async (e) => {
                    const cep = e.target.value.replace(/\D/g, '');
                    if (cep.length !== 8) return;
                    try {
                        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                        const data = await response.json();
                        if (data.erro) { showToast('CEP não encontrado.', 'error'); return; }
                        document.getElementById('cidadao-logradouro').value = data.logradouro;
                        document.getElementById('cidadao-bairro').value = data.bairro;
                        document.getElementById('cidadao-cidade').value = data.localidade;
                        document.getElementById('cidadao-estado').value = data.uf;
                        document.getElementById('cidadao-numero').focus();
                    } catch (error) { console.error('Erro ao buscar CEP:', error); showToast('Erro ao consultar o CEP.', 'error'); }
                });

                function renderChildrenFields() {
                    childrenContainer.innerHTML = '';
                    const sonsCount = parseInt(sonsInput.value) || 0;
                    const daughtersCount = parseInt(daughtersInput.value) || 0;
                    if (sonsCount === 0 && daughtersCount === 0) return;

                    const header = document.createElement('h3');
                    header.className = 'text-lg font-semibold text-gray-800 border-t pt-4';
                    header.textContent = 'Detalhes dos Filhos e Filhas';
                    childrenContainer.appendChild(header);

                    for (let i = 1; i <= sonsCount; i++) childrenContainer.appendChild(createChildFieldset(i, 'Filho'));
                    for (let i = 1; i <= daughtersCount; i++) childrenContainer.appendChild(createChildFieldset(i, 'Filha'));
                }
                function createChildFieldset(index, type) {
                    const fieldset = document.createElement('fieldset');
                    fieldset.className = 'border p-3 rounded-lg grid grid-cols-1 sm:grid-cols-3 gap-4 mt-2';
                    fieldset.innerHTML = `
                        <legend class="px-2 font-medium text-sm">${type} ${index}</legend>
                        <div><label class="block text-xs font-medium text-gray-600">Nome</label><input type="text" class="child-detail-name w-full border border-gray-300 p-2 rounded-lg mt-1" required></div>
                        <div><label class="block text-xs font-medium text-gray-600">CPF</label><input type="text" class="child-detail-cpf w-full border border-gray-300 p-2 rounded-lg mt-1" placeholder="000.000.000-00"></div>
                        <div><label class="block text-xs font-medium text-gray-600">Data de Nasc.</label><input type="date" class="child-detail-dob w-full border border-gray-300 p-2 rounded-lg mt-1"></div>
                    `;
                    return fieldset;
                }
                sonsInput.addEventListener('input', renderChildrenFields);
                daughtersInput.addEventListener('input', renderChildrenFields);
                const maskpatterns = { 'cidadao-cpf': '000.000.000-00', 'cidadao-cep': '00000-000', 'cidadao-phone': '(00) 00000-0000', 'cidadao-voterid': '0000 0000 0000' };
                function applyMask(e) {
                    const { id, value } = e.target;
                    let pattern = maskpatterns[id];
                     if (!pattern && e.target.classList.contains('child-detail-cpf')) { pattern = '000.000.000-00'; }
                    if (!pattern) return;
                    const numericValue = value.replace(/\D/g, '');
                    let formattedValue = ''; let valueIndex = 0;
                    for (let i = 0; i < pattern.length && valueIndex < numericValue.length; i++) { formattedValue += pattern[i] === '0' ? numericValue[valueIndex++] : pattern[i]; }
                    e.target.value = formattedValue;
                }
                ['cidadao-cpf', 'cidadao-cep', 'cidadao-phone', 'cidadao-voterid'].forEach(id => document.getElementById(id).addEventListener('input', applyMask));
                childrenContainer.addEventListener('input', applyMask);
                
                document.getElementById('cidadao-photo-upload').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) {
                        document.getElementById('file-name-display').textContent = 'Nenhuma foto selecionada';
                        photoPreview.classList.add('hidden');
                        return;
                    }
                    document.getElementById('file-name-display').textContent = file.name;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        photoPreview.src = event.target.result;
                        photoPreview.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                });


                function populateLeadersDropdown(isForm = false) {
                    const select = isForm ? leaderSelect : filterLeader;
                    const currentVal = select.value;
                    select.innerHTML = `<option value="">${isForm ? 'Nenhuma' : 'Filtrar por Liderança'}</option>`;
                    allLeaders.forEach(leader => {
                        const option = document.createElement('option');
                        option.value = leader.id;
                        option.textContent = leader.name;
                        select.appendChild(option);
                    });
                    select.value = currentVal;
                }

                cidadaoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const cpf = document.getElementById('cidadao-cpf').value;
                    const voterId = document.getElementById('cidadao-voterid').value;

                    if (cpf || voterId) {
                        const queries = [];
                        if (cpf) queries.push(getDocs(query(cidadaosCollection, where("cpf", "==", cpf))));
                        if (voterId) queries.push(getDocs(query(cidadaosCollection, where("voterId", "==", voterId))));

                        const results = await Promise.all(queries);
                        let duplicateDoc = null, duplicateField = '';

                        if (results[0] && !results[0].empty) {
                            results[0].forEach(doc => { if (doc.id !== editingCidadaoId) { duplicateDoc = doc; duplicateField = 'CPF'; } });
                        }

                        if (!duplicateDoc && results[cpf ? 1 : 0] && !results[cpf ? 1 : 0].empty) {
                             results[cpf ? 1 : 0].forEach(doc => { if (doc.id !== editingCidadaoId) { duplicateDoc = doc; duplicateField = 'Título de Eleitor'; } });
                        }

                        if (duplicateDoc) {
                            const duplicateData = duplicateDoc.data();
                            const leader = allLeaders.find(l => l.id === duplicateData.leaderId);
                            showToast(`${duplicateField} já cadastrado (Líder: ${leader ? leader.name : 'não informado'}).`, 'error');
                            return;
                        }
                    }
                    
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<div class="spinner"></div><span>A Salvar...</span>';

                    const childrenData = Array.from(document.querySelectorAll('#children-details-container fieldset')).map(fieldset => ({
                        name: fieldset.querySelector('.child-detail-name').value,
                        cpf: fieldset.querySelector('.child-detail-cpf').value,
                        dob: fieldset.querySelector('.child-detail-dob').value
                    }));

                    const fullAddress = `${document.getElementById('cidadao-logradouro').value}, ${document.getElementById('cidadao-numero').value}, ${document.getElementById('cidadao-bairro').value}, ${document.getElementById('cidadao-cidade').value} - ${document.getElementById('cidadao-estado').value}`;
                    const coords = await geocodeAddress(fullAddress);
                    
                    const cidadaoData = {
                        name: document.getElementById('cidadao-name').value, email: document.getElementById('cidadao-email').value, dob: document.getElementById('cidadao-dob').value,
                        type: document.getElementById('cidadao-type').value, cpf: cpf, rg: document.getElementById('cidadao-rg').value,
                        voterId: voterId, phone: document.getElementById('cidadao-phone').value,
                        hasWhatsApp: document.getElementById('cidadao-whatsapp').checked, 
                        profissao: document.getElementById('cidadao-profissao').value,
                        localTrabalho: document.getElementById('cidadao-local-trabalho').value,
                        address: {
                            cep: document.getElementById('cidadao-cep').value, logradouro: document.getElementById('cidadao-logradouro').value,
                            numero: document.getElementById('cidadao-numero').value, complemento: document.getElementById('cidadao-complemento').value,
                            bairro: document.getElementById('cidadao-bairro').value, cidade: document.getElementById('cidadao-cidade').value,
                            estado: document.getElementById('cidadao-estado').value,
                        },
                        lat: coords?.lat || null, lon: coords?.lon || null,
                        leaderId: document.getElementById('cidadao-leader').value,
                        sons: parseInt(sonsInput.value) || 0, daughters: parseInt(daughtersInput.value) || 0, children: childrenData,
                        initials: document.getElementById('cidadao-name').value.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()
                    };
                    
                    const photoFile = document.getElementById('cidadao-photo-upload').files[0];

                    try {
                        if (photoFile) {
                            const storageRef = ref(storage, `profile_photos/${appId}/${Date.now()}_${photoFile.name}`);
                            const uploadTask = uploadBytesResumable(storageRef, photoFile);

                            uploadTask.on('state_changed', 
                                (snapshot) => {
                                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                    uploadProgress.value = progress;
                                    uploadProgress.classList.remove('hidden');
                                }, 
                                (error) => {
                                    console.error("Upload error:", error);
                                    showToast('Erro ao carregar a foto.', 'error');
                                    saveBtn.disabled = false; saveBtn.innerHTML = 'Salvar';
                                }, 
                                async () => {
                                    cidadaoData.photo = await getDownloadURL(uploadTask.snapshot.ref);
                                    await saveCidadao(cidadaoData);
                                }
                            );
                        } else {
                             const existingCidadao = editingCidadaoId ? allCidadaos.find(c => c.id === editingCidadaoId) : null;
                             cidadaoData.photo = existingCidadao?.photo || null;
                             if (!cidadaoData.photo) {
                                cidadaoData.color = existingCidadao?.color || ['bg-purple-500', 'bg-teal-500', 'bg-indigo-500', 'bg-pink-500'][Math.floor(Math.random() * 4)];
                             }
                            await saveCidadao(cidadaoData);
                        }
                    } catch (error) {
                         console.error("Erro ao processar formulário: ", error); showToast('Erro ao salvar cidadão.', 'error');
                         saveBtn.disabled = false; saveBtn.innerHTML = 'Salvar';
                    }
                });

                async function saveCidadao(data) {
                     try {
                        if (editingCidadaoId) {
                            await updateDoc(doc(db, "cidadaos", editingCidadaoId), data);
                            showToast('Cidadão atualizado com sucesso!');
                        } else {
                            await addDoc(cidadaosCollection, data);
                            showToast('Cidadão adicionado com sucesso!');
                        }
                        closeCidadaoModal();
                    } catch (error) {
                        console.error("Erro ao salvar no Firestore: ", error); showToast('Erro ao salvar dados.', 'error');
                    } finally {
                         saveBtn.disabled = false; saveBtn.innerHTML = 'Salvar';
                    }
                }
                
                // --- Lógica de Demandas ---
                function renderAllDemandas() {
                    let filteredDemandas = [...allDemandas];
                    const status = demandaFilterStatus.value;
                    if (status) {
                        filteredDemandas = filteredDemandas.filter(d => d.status === status);
                    }
                    const leaderId = demandaFilterLeader.value;
                    if (leaderId) {
                        const groupMemberIds = allCidadaos.filter(c => c.leaderId === leaderId).map(c => c.id);
                        groupMemberIds.push(leaderId);
                        filteredDemandas = filteredDemandas.filter(d => groupMemberIds.includes(d.cidadaoId));
                    }
                    allDemandasList.innerHTML = '';
                    if (filteredDemandas.length === 0) {
                        allDemandasList.innerHTML = '<p class="text-slate-500 text-center mt-8">Nenhuma demanda encontrada com os filtros aplicados.</p>';
                        return;
                    }
                    const statusMap = { pending: "Pendente", inprogress: "Em Andamento", completed: "Concluída" };
                    const statusClassMap = { pending: "status-pending", inprogress: "status-inprogress", completed: "status-completed" };
                    filteredDemandas.forEach(demanda => {
                        const cidadao = allCidadaos.find(c => c.id === demanda.cidadaoId);
                        const leader = allLeaders.find(l => l.id === cidadao?.leaderId);
                        const item = document.createElement('div');
                        item.dataset.id = demanda.id;
                        item.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:shadow-md';
                        item.innerHTML = `
                            <div>
                                <h4 class="font-bold text-lg text-gray-800">${demanda.title}</h4>
                                <p class="text-sm text-gray-500">Solicitante: ${cidadao ? cidadao.name : 'Desconhecido'} ${leader ? `(Grupo de ${leader.name})` : ''}</p>
                            </div>
                            <span class="status-badge ${statusClassMap[demanda.status]}">${statusMap[demanda.status]}</span>
                        `;
                        allDemandasList.appendChild(item);
                    });
                }
                [demandaFilterStatus, demandaFilterLeader].forEach(el => el.addEventListener('input', renderAllDemandas));
                demandaClearFiltersBtn.addEventListener('click', () => {
                    demandaFilterStatus.value = '';
                    demandaFilterLeader.value = '';
                    renderAllDemandas();
                });
                function openNewDemandaModal() {
                    demandaForm.reset();
                    demandaFormCidadaoSelect.innerHTML = '<option value="" disabled selected>Selecione um cidadão...</option>';
                    allCidadaos.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        demandaFormCidadaoSelect.appendChild(option);
                    });
                    demandaModal.classList.remove('hidden');
                }
                addDemandaGeralBtn.addEventListener('click', openNewDemandaModal);
                allDemandasList.addEventListener('click', (e) => {
                    const item = e.target.closest('div[data-id]');
                    if (item) {
                        openDemandaDetailsModal(item.dataset.id);
                    }
                });
                closeDemandaModalBtn.addEventListener('click', () => demandaModal.classList.add('hidden'));
                cancelDemandaBtn.addEventListener('click', () => demandaModal.classList.add('hidden'));
                demandaForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const title = document.getElementById('demanda-title').value;
                    const description = document.getElementById('demanda-description').value;
                    const cidadaoId = demandaFormCidadaoSelect.value;
                    if (!cidadaoId) {
                        showToast('Por favor, selecione um cidadão.', 'error');
                        return;
                    }
                    await addDoc(demandasCollection, {
                        title, description, cidadaoId,
                        status: 'pending', createdAt: serverTimestamp()
                    });
                    showToast('Demanda adicionada com sucesso!');
                    demandaForm.reset();
                    demandaModal.classList.add('hidden');
                });
                
                async function openDemandaDetailsModal(demandaId) {
                    viewingDemandaId = demandaId;
                    const demanda = allDemandas.find(d => d.id === demandaId);
                    const cidadao = allCidadaos.find(c => c.id === demanda.cidadaoId);
                    detailsDemandaTitle.textContent = demanda.title;
                    detailsDemandaCidadao.textContent = `Para: ${cidadao ? cidadao.name : 'Desconhecido'}`;
                    detailsDemandaDescription.textContent = demanda.description || 'Sem descrição.';
                    detailsDemandaStatus.value = demanda.status;
                    if (notesUnsubscribe) notesUnsubscribe();
                    const notesCollection = collection(db, "demandas", demandaId, "notes");
                    notesUnsubscribe = onSnapshot(query(notesCollection, orderBy("createdAt", "asc")), (snapshot) => {
                        demandaNotesList.innerHTML = '';
                        if(snapshot.empty) { demandaNotesList.innerHTML = `<p class="text-sm text-gray-500">Nenhum acompanhamento adicionado.</p>`; return; }
                        snapshot.docs.forEach(doc => {
                            const note = doc.data();
                            const noteEl = document.createElement('div');
                            noteEl.className = 'bg-gray-100 p-3 rounded-lg';
                            const noteDate = note.createdAt ? note.createdAt.toDate().toLocaleString('pt-BR') : 'A guardar...';
                            const userEmail = note.userEmail ? `por <b>${note.userEmail}</b>` : '';
                            noteEl.innerHTML = `<p class="text-sm text-gray-800">${note.text}</p><p class="text-xs text-gray-500 text-right mt-1">Adicionado ${userEmail} em ${noteDate}</p>`;
                            demandaNotesList.appendChild(noteEl);
                        });
                    });
                    demandaDetailsModal.classList.remove('hidden');
                }
                function closeDemandaDetailsModal() {
                    if (notesUnsubscribe) notesUnsubscribe();
                    viewingDemandaId = null;
                    demandaDetailsModal.classList.add('hidden');
                }
                closeDemandaDetailsBtn.addEventListener('click', closeDemandaDetailsModal);
                detailsDemandaStatus.addEventListener('change', async (e) => {
                    if (viewingDemandaId) {
                        await updateDoc(doc(db, "demandas", viewingDemandaId), { status: e.target.value });
                        showToast('Status da demanda atualizado!', 'info');
                    }
                });
                addNoteForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const text = newNoteText.value.trim();
                    if (!viewingDemandaId || !text) return;
                    const user = auth.currentUser;
                    const notesCollection = collection(db, "demandas", viewingDemandaId, "notes");
                    await addDoc(notesCollection, { text, createdAt: serverTimestamp(), userEmail: user.email });
                    addNoteForm.reset();
                });

                function openConfirmationModal(id, type, email = '') {
                    itemToDelete = { id, type, email };
                    confirmationTitle.textContent = `Confirmar Exclusão de ${type === 'cidadao' ? 'Cidadão' : (type === 'demanda' ? 'Demanda' : 'Utilizador')}`;
                    confirmationMessage.textContent = `Você tem certeza? Esta ação não pode ser desfeita.${type === 'cidadao' ? ' Todas as demandas associadas também serão excluídas.' : ''}`;
                    confirmationModal.classList.remove('hidden');
                }
                cancelDeleteBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
                confirmDeleteBtn.addEventListener('click', async () => {
                    if (!itemToDelete.id) return;
                    const { id, type } = itemToDelete;
                    const batch = writeBatch(db);
                    if (type === 'cidadao') {
                        const demandsQuery = query(demandasCollection, where("cidadaoId", "==", id));
                        const demandsSnapshot = await getDocs(demandsQuery);
                        demandsSnapshot.forEach(d => batch.delete(d.ref));
                        batch.delete(doc(db, "cidadaos", id));
                    } else if (type === 'demanda') {
                        const notesCollection = collection(db, "demandas", id, "notes");
                        const notesSnapshot = await getDocs(notesCollection);
                        notesSnapshot.forEach(d => batch.delete(d.ref));
                        batch.delete(doc(db, "demandas", id));
                        closeDemandaDetailsModal();
                    } else if (type === 'user') {
                         batch.delete(doc(db, "users", id));
                    }

                    await batch.commit();
                    showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} excluído(a) com sucesso.`, 'error');
                    confirmationModal.classList.add('hidden');
                });
                
                deleteDemandaBtn.addEventListener('click', () => {
                    if (viewingDemandaId) openConfirmationModal(viewingDemandaId, 'demanda');
                });

                function openCidadaoDetailsModal(cidadaoId) {
                    viewingCidadaoId = cidadaoId;
                    const cidadao = allCidadaos.find(c => c.id === cidadaoId);
                    if (!cidadao) return;
                    const photoEl = document.getElementById('details-photo');
                    photoEl.innerHTML = cidadao.photo ? `<img src="${cidadao.photo}" class="w-24 h-24 object-cover rounded-full" alt="Foto de ${cidadao.name}">` : `<div class="w-24 h-24 ${cidadao.color || 'bg-gray-500'} rounded-full flex items-center justify-center text-white text-4xl font-bold">${cidadao.initials || '??'}</div>`;
                    document.getElementById('details-name').textContent = cidadao.name;
                    document.getElementById('details-type').textContent = cidadao.type;
                    document.getElementById('details-email').textContent = cidadao.email || 'N/A';
                    document.getElementById('details-phone').textContent = cidadao.phone || 'N/A';
                    const addr = cidadao.address;
                    const fullAddress = addr ? `${addr.logradouro || ''}, ${addr.numero || 'S/N'}<br>${addr.bairro || ''}, ${addr.cidade || ''} - ${addr.estado || ''}` : 'N/A';
                    document.getElementById('details-address').innerHTML = fullAddress;
                    document.getElementById('details-cpf').textContent = cidadao.cpf || 'N/A';
                    document.getElementById('details-rg').textContent = cidadao.rg || 'N/A';
                    document.getElementById('details-voterid').textContent = cidadao.voterId || 'N/A';
                    document.getElementById('details-profissao').textContent = cidadao.profissao || 'N/A';
                    document.getElementById('details-local-trabalho').textContent = cidadao.localTrabalho || 'N/A';
                    const dob = cidadao.dob ? new Date(cidadao.dob).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'N/A';
                    document.getElementById('details-dob').textContent = dob;
                    const leader = allLeaders.find(l => l.id === cidadao.leaderId);
                    document.getElementById('details-leader').textContent = leader ? leader.name : 'Nenhuma';
                    const childrenDetailsEl = document.getElementById('details-children');
                    childrenDetailsEl.innerHTML = '';
                    if(cidadao.children && cidadao.children.length > 0) {
                         childrenDetailsEl.innerHTML = '<h4 class="font-semibold text-gray-500 text-sm mt-2">FILHOS/FILHAS</h4>' + cidadao.children.map(child => `<p class="text-sm">${child.name || 'Nome não informado'} (${child.dob ? new Date(child.dob).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 's/ data'})</p>`).join('');
                    }
                    cidadaoDetailsModal.classList.remove('hidden');
                    setTimeout(() => cidadaoDetailsModal.querySelector('.modal-transition').classList.remove('scale-95', 'opacity-0'), 10);
                }
                function closeCidadaoDetailsModal() {
                     cidadaoDetailsModal.querySelector('.modal-transition').classList.add('scale-95', 'opacity-0');
                     setTimeout(() => {
                        cidadaoDetailsModal.classList.add('hidden');
                        viewingCidadaoId = null;
                     }, 300);
                }
                closeDetailsModalBtn.addEventListener('click', closeCidadaoDetailsModal);
                detailsViewMapBtn.addEventListener('click', () => {
                    const cidadao = allCidadaos.find(c => c.id === viewingCidadaoId);
                    if (cidadao && cidadao.lat && cidadao.lon) {
                        closeCidadaoDetailsModal();
                        mapModal.classList.remove('hidden');
                        initializeMap();
                        setTimeout(() => { 
                            map.invalidateSize();
                            map.setView([cidadao.lat, cidadao.lon], 16);
                            L.marker([cidadao.lat, cidadao.lon]).addTo(map).bindPopup(`<b>${cidadao.name}</b>`).openPopup();
                        }, 10);
                    } else {
                        showToast('Este cidadão não possui localização cadastrada.', 'error');
                    }
                });
                detailsShareLocationBtn.addEventListener('click', () => {
                    const cidadao = allCidadaos.find(c => c.id === viewingCidadaoId);
                    if(cidadao && cidadao.lat && cidadao.lon) {
                        const url = `https://www.google.com/maps?q=${cidadao.lat},${cidadao.lon}`;
                        navigator.clipboard.writeText(url).then(() => {
                            showToast('Link da localização copiado!');
                        }).catch(() => {
                            showToast('Erro ao copiar o link.', 'error');
                        });
                    } else {
                         showToast('Este cidadão não possui localização cadastrada.', 'error');
                    }
                });

                async function geocodeAddress(address) {
                     if (!address || address.trim().length < 10) return null;
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                        if (!response.ok) return null;
                        const data = await response.json();
                        return (data && data.length > 0) ? { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) } : null;
                    } catch (error) { console.error("Erro na geocodificação:", error); return null; }
                }
                function initializeMap() {
                    if (map) return;
                    map = L.map('map').setView([-14.235, -51.9253], 4);
                    const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
                    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' });
                    const baseMaps = { "Ruas": streets, "Satélite": satellite };
                    streets.addTo(map);
                    L.control.layers(baseMaps).addTo(map);
                }
                function populateMap() {
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];
                    const cidadaosWithLocation = allCidadaos.filter(c => c.lat && c.lon);
                    if (cidadaosWithLocation.length === 0) { showToast("Nenhum cidadão com endereço para exibir.", "info"); return; }
                    cidadaosWithLocation.forEach(cidadao => {
                        const marker = L.marker([cidadao.lat, cidadao.lon]).addTo(map).bindPopup(`<b>${cidadao.name}</b><br>${cidadao.type}`);
                        markers.push(marker);
                    });
                    if(markers.length > 0) { const group = new L.featureGroup(markers); map.fitBounds(group.getBounds().pad(0.2)); }
                }
                viewMapBtn.addEventListener('click', () => {
                    mapModal.classList.remove('hidden');
                    initializeMap();
                    setTimeout(() => { map.invalidateSize(); populateMap(); }, 10);
                });
                closeMapBtn.addEventListener('click', () => mapModal.classList.add('hidden'));

                function generateReport() {
                    let filteredCidadaos = [...allCidadaos];
                    const searchTerm = searchInput.value.toLowerCase();
                    if (searchTerm) { filteredCidadaos = filteredCidadaos.filter(c => c.name.toLowerCase().includes(searchTerm) || c.email.toLowerCase().includes(searchTerm) || (c.cpf && c.cpf.includes(searchTerm)));}
                    const type = filterType.value;
                    if (type) { filteredCidadaos = filteredCidadaos.filter(c => c.type === type); }
                    const bairro = filterBairro.value;
                    if (bairro) { filteredCidadaos = filteredCidadaos.filter(c => c.address && c.address.bairro === bairro); }
                    const leaderId = filterLeader.value;
                    if (leaderId) { filteredCidadaos = filteredCidadaos.filter(c => c.leaderId === leaderId); }
                    if (filteredCidadaos.length === 0) { showToast('Nenhum dado para gerar relatório com os filtros atuais.', 'error'); return; }
                    const reportWindow = window.open('', '_blank');
                    const filtersApplied = [ searchTerm ? `Busca: "${searchTerm}"` : '', type ? `Tipo: "${type}"` : '', bairro ? `Bairro: "${bairro}"` : '', leaderId ? `Liderança: "${allLeaders.find(l => l.id === leaderId)?.name}"` : '' ].filter(Boolean).join('; ');
                    let reportHTML = `
                        <html>
                            <head><title>Relatório de Cidadãos</title><script src="https://cdn.tailwindcss.com"><\/script><style> @media print { body { -webkit-print-color-adjust: exact; } #print-button { display: none; } } </style></head>
                            <body class="p-8 font-sans">
                                <div class="flex justify-between items-center mb-6">
                                    <div>
                                        <h1 class="text-3xl font-bold">Relatório de Cidadãos</h1>
                                        <p class="text-gray-600">Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}</p>
                                        ${filtersApplied ? `<p class="text-sm text-gray-500 mt-2"><b>Filtros Aplicados:</b> ${filtersApplied}</p>` : ''}
                                    </div>
                                    <button id="print-button" onclick="window.print()" class="bg-blue-600 text-white py-2 px-4 rounded-lg">Imprimir</button>
                                </div>
                                <table class="w-full text-left border-collapse">
                                    <thead><tr class="bg-gray-200"><th class="p-3 border">Nome</th><th class="p-3 border">Tipo</th><th class="p-3 border">Profissão</th><th class="p-3 border">Telefone</th><th class="p-3 border">Bairro</th><th class="p-3 border">Liderança</th></tr></thead><tbody>`;
                    filteredCidadaos.forEach(c => {
                        const leader = allLeaders.find(l => l.id === c.leaderId);
                        reportHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-3 border">${c.name}</td><td class="p-3 border">${c.type}</td><td class="p-3 border">${c.profissao || 'N/A'}</td><td class="p-3 border">${c.phone || 'N/A'}</td><td class="p-3 border">${c.address?.bairro || 'N/A'}</td><td class="p-3 border">${leader?.name || 'Nenhuma'}</td></tr>`;
                    });
                    reportHTML += `</tbody></table><p class="text-right text-gray-700 mt-4">Total de Cidadãos: <b>${filteredCidadaos.length}</b></p></body></html>`;
                    reportWindow.document.write(reportHTML);
                    reportWindow.document.close();
                }
                generateReportBtn.addEventListener('click', generateReport);

                function listenForFirebaseData() {
                    globalLoader.classList.remove('hidden'); // Mostra o loader
                    
                    let dataLoaded = { cidadaos: false, demandas: false, users: false };
                    const checkAllDataLoaded = () => {
                        if (Object.values(dataLoaded).every(Boolean)) {
                            globalLoader.classList.add('hidden');
                        }
                    };

                    unsubscribeCidadaos = onSnapshot(query(cidadaosCollection, orderBy("name")), (snapshot) => {
                        allCidadaos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        allLeaders = allCidadaos.filter(c => c.type === 'Liderança');
                        renderCidadaos();
                        populateFilterDropdowns();
                        updateDashboard();
                        dataLoaded.cidadaos = true; checkAllDataLoaded();
                    });
                    unsubscribeDemandas = onSnapshot(query(demandasCollection, orderBy("createdAt", "desc")), (snapshot) => {
                        allDemandas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderAllDemandas();
                        updateDashboard();
                        dataLoaded.demandas = true; checkAllDataLoaded();
                    });
                     unsubscribeUsers = onSnapshot(query(usersCollection, orderBy("email")), (snapshot) => {
                        allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderUsersTable();
                        dataLoaded.users = true; checkAllDataLoaded();
                    });
                }

                // --- GESTÃO DE UTILIZADORES ---
                function renderUsersTable() {
                    usersTableBody.innerHTML = '';
                    if (allUsers.length > 0) {
                         allUsers.forEach(user => {
                            const tr = document.createElement('tr');
                            tr.className = 'border-b';
                            const deleteBtnUser = currentUserRole === 'Administrador' ? `<button data-id="${user.id}" data-email="${user.email}" aria-label="Excluir Utilizador" class="delete-user-btn ml-4 text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>` : '';
                            tr.innerHTML = `
                                <td class="p-4">${user.email}</td>
                                <td class="p-4">${user.role}</td>
                                <td class="p-4">${deleteBtnUser}</td>
                            `;
                             usersTableBody.appendChild(tr);
                        });
                    }
                }
                 usersTableBody.addEventListener('click', e => {
                    const deleteBtn = e.target.closest('.delete-user-btn');
                     if (deleteBtn) {
                        openConfirmationModal(deleteBtn.dataset.id, 'user', deleteBtn.dataset.email);
                    }
                });


                addUserBtn.addEventListener('click', () => { userModal.classList.remove('hidden'); });
                closeUserModalBtn.addEventListener('click', () => { userModal.classList.add('hidden'); userForm.reset(); });
                cancelUserBtn.addEventListener('click', () => { userModal.classList.add('hidden'); userForm.reset(); });
                
                userForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('user-email').value;
                    const uid = document.getElementById('user-uid').value;
                    const role = document.getElementById('user-role').value;
                    
                    if(!uid) {
                        showToast('O User ID (UID) é obrigatório.', 'error');
                        return;
                    }

                    const userDocRef = doc(db, "users", uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if(userDocSnap.exists()) {
                        showToast('Um utilizador com este UID já está registado.', 'error');
                        return;
                    }
                    
                    try {
                         await setDoc(userDocRef, { email, role, uid });
                        showToast('Utilizador adicionado com sucesso.');
                        userForm.reset();
                        userModal.classList.add('hidden');
                    } catch (error) {
                        console.error("Erro ao adicionar utilizador:", error);
                        showToast('Erro ao salvar o utilizador.', 'error');
                    }
                });
                
                switchPage('dashboard-page');
                listenForFirebaseData();
                applyPermissions(currentUserRole);
            }
        });

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'p-4 rounded-lg shadow-lg text-white flex items-center gap-3 opacity-0 transform translate-x-10 transition-all duration-300';
            let icon = '';
            if (type === 'success') {
                toast.classList.add('bg-green-500');
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`;
            } else {
                toast.classList.add('bg-blue-500');
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            }
            toast.innerHTML = `${icon}<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.classList.remove('opacity-0', 'translate-x-10'); }, 10);
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-x-10'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        }
    </script>
</body>
</html>